<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADMIN | MANAGER</title>
  <link rel="stylesheet" href="style.css">

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>

<body>

  <div id="loginOverlay" class="login-modal">
    <div class="login-box">
      <div class="logo-container"><img src="logo.png" alt="Logo" class="site-logo"></div>
      <h2>ADMIN LOGIN</h2>

      <input type="email" id="adminEmail" placeholder="EMAIL (admin@shop.com)"
        style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">

      <input type="password" id="adminPass" placeholder="PASSWORD"
        style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">

      <button onclick="checkLogin()" style="width: 100%;">ACCESS</button>
      <p id="loginError" style="color:red; display:none; margin-top:10px; font-size: 12px;">LOGIN FAILED</p>
    </div>
  </div>

  <div class="container" id="adminPanel" style="display:none;">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div style="display:flex; align-items:center; gap:10px;">
        <img src="logo.png" style="height:30px;">
        <h2 style="margin:0;">QUEUE MANAGER</h2>
      </div>
      <button onclick="logout()" class="btn-outline">LOGOUT</button>
    </header>

    <div class="input-group">
      <select id="qType" style="flex: 0.5;">
        <option value="Normal">Normal</option>
        <option value="VIP">‚òÖ VIP</option>
      </select>
      <input type="text" id="custName" placeholder="Customer Name" style="flex: 2;">
      <input type="number" id="modelCount" placeholder="Qty" style="flex: 0.5;">
      <input type="text" id="adminComment" placeholder="Note" style="flex: 2;">
      <button onclick="addQueue()">+ ADD</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Time</th>
          <th>Customer</th>
          <th>Note</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="queueTableBody"></tbody>
    </table>
  </div>

  <script>
    // --- ‚ö†Ô∏è Config Firebase ‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏á ---
    const firebaseConfig = {
      apiKey: "AIzaSyBgL1Lg8-ASTob81B00N70LmFpGIzoYEt8",
      authDomain: "database-queuepes.firebaseapp.com",
      databaseURL: "https://database-queuepes-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "database-queuepes",
      storageBucket: "database-queuepes.firebasestorage.app",
      messagingSenderId: "440285644844",
      appId: "1:440285644844:web:ed788db8a1827fa1e82989",
      measurementId: "G-Z80T43KV3D"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    function checkLogin() {
      // üëá 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ Fix ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö
      const email = document.getElementById('adminEmail').value;
      const pass = document.getElementById('adminPass').value;

      if (!email || !pass) {
        alert("Please enter Email and Password");
        return;
      }

      auth.signInWithEmailAndPassword(email, pass)
        .then((userCredential) => {
          // ‡∏ñ‡πâ‡∏≤ Login ‡∏ú‡πà‡∏≤‡∏ô
          document.getElementById('loginOverlay').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          loadQueue();
        })
        .catch((error) => {
          // ‡∏ñ‡πâ‡∏≤ Login ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
          console.error(error);
          document.getElementById('loginError').style.display = 'block';
          document.getElementById('loginError').innerText = "Incorrect Email or Password";
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢ Login ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà)
    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadQueue();
      }
    });

    function logout() {
      auth.signOut().then(() => {
        location.reload();
      });
    }

    // --- Logic 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥ ---
    function generateID() { return Math.random().toString(36).substr(2, 6).toUpperCase(); }

    function addQueue() {
      const type = document.getElementById('qType').value;
      const name = document.getElementById('custName').value;
      const count = document.getElementById('modelCount').value;
      const note = document.getElementById('adminComment').value;

      if (!name || !count) return alert("Please fill all fields");

      saveWithUniqueCheck({
        type: type,
        name: name,
        model: count,
        comment: note,
        status: 'waiting',
        orderDate: new Date().toISOString(),
        finishedDate: ''
      });
    }

    function saveWithUniqueCheck(data) {
      const id = generateID();
      db.ref('queues/' + id).once('value').then(snapshot => {
        if (snapshot.exists()) {
          console.log("ID ‡∏ã‡πâ‡∏≥! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà...");
          saveWithUniqueCheck(data);
        } else {
          db.ref('queues/' + id).set({ ...data, id: id });
          clearInputs();
        }
      });
    }

    function clearInputs() {
      document.getElementById('custName').value = '';
      document.getElementById('modelCount').value = '';
      document.getElementById('adminComment').value = '';
      document.getElementById('qType').value = 'Normal';
    }

    // --- Logic 2: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤) + ‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
    function loadQueue() {
      // ‡πÉ‡∏ä‡πâ orderByChild ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡∏¢
      db.ref('queues').orderByChild('orderDate').on('value', (snapshot) => {
        const tbody = document.getElementById('queueTableBody');
        tbody.innerHTML = '';

        snapshot.forEach((child) => {
          const item = child.val();

          if (item.status === 'finished' && !checkWarranty(item.finishedDate)) {
            console.log(`Auto Deleting Expired ID: ${item.id}`);
            db.ref('queues/' + item.id).remove();
            return;
          }

          const date = new Date(item.orderDate).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          let typeBadge = item.type === 'VIP' ? '<span class="type-vip">VIP</span>' : '';

          let statusBadge = '';
          if (item.status === 'waiting') statusBadge = '<span class="badge badge-wait">WAITING</span>';
          else if (item.status === 'working') statusBadge = '<span class="badge badge-work">WORKING</span>';
          else {
            statusBadge = '<span class="badge badge-done">FINISHED (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô)</span>';
          }

          tbody.innerHTML += `
              <tr>
                  <td style="font-family:monospace;">${item.id}</td>
                  <td>${date}</td>
                  <td>${typeBadge} <strong>${item.name}</strong> (${item.model})</td>
                  <td style="color:#777; font-size:12px;">${item.comment || '-'}</td>
                  <td>${statusBadge}</td>
                  <td>
                      <button onclick="setStatus('${item.id}','working')" class="btn-outline">DO</button>
                      <button onclick="setStatus('${item.id}','finished')" class="btn-outline">FIN</button>
                      <button onclick="del('${item.id}')" class="btn-outline" style="border-color:red; color:red;">X</button>
                  </td>
              </tr>
          `;
        });
      });
    }

    function checkWarranty(dateStr) {
      if (!dateStr) return true;
      const diff = new Date() - new Date(dateStr);
      const days = diff / (1000 * 60 * 60 * 24);
      return days <= 3;
    }

    function setStatus(id, s) {
      let updates = { status: s };
      if (s === 'finished') updates.finishedDate = new Date().toISOString();
      else updates.finishedDate = '';
      db.ref('queues/' + id).update(updates);
    }
    function del(id) { if (confirm("Delete?")) db.ref('queues/' + id).remove(); }
  </script>
</body>

</html>